---
title: "COMBINED_Taxi-Analysis"
author: "Steven Chao, Tanaya Kavathekar, Madhuri Yadav, Amna Gul"
date: '`r Sys.Date()`'
output:
  html_document:
    number_sections: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)
#knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(include = F)
```

```{r basicfcn, include=F}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
```

```{r load libraries, echo=FALSE}
loadPkg("dplyr")
loadPkg("ggplot2")
loadPkg("data.table")
# loadPkg("grid")
# loadPkg("gridExtra")
# loadPkg("egg")
```

# Introduction

## Problem statement
Should you pay tip to the taxi driver? If yes, how much?

Analyse the factors which takes place to determine the tip amount paid to the driver

Why?
Benefits?
Use?

Hypothesis:
Factors that can affect tip amount:
1. Vendor service
2. Driver service
3. Location :  (generous locations)
4. duration of day 
5. distance
6. count of passengers
7. weather

# Data preprocessing

## Load data
write where data is collected from 
```{r read data files}
unprocessed_data = read.csv("../Data/trips_zones_20000_v2.csv")
taxi_zones <- read.csv("../Data/taxi_zone_lookup.csv")

glimpse(unprocessed_data)

glimpse(taxi_zones)
```


```{r merge location descriptions}
processed_df <- merge(x = processed_df, y = taxi_zones, by.x = "PULocationID", by.y = "LocationID", all.x = TRUE)

processed_df <- subset(processed_df, select = -c(Zone, service_zone))

colnames(processed_df)[colnames(processed_df)=="Borough"] <- "Borough_pu"

processed_df <- merge(x = processed_df, y = taxi_zones, by.x = "DOLocationID", by.y = "LocationID", all.x = TRUE)

colnames(processed_df)[colnames(processed_df)=="Borough"] <- "Borough_do"
unique(processed_df$Borough_do)

```

## Data statistics 
per_tip creation

```{r }
# get percentage tip amount
unprocessed_data['per_tip'] = unprocessed_data['tip_amount'] / unprocessed_data['fare_amount'] 
summary(unprocessed_data)
print(sd(processed_df$per_tip))
print(mean(processed_df$per_tip))
```


## Outlier detection and data filters

```{r Outlier detection and missing values, echo=T}

# fare amount in negative & credit card payments
processed_df <- unprocessed_data %>% filter((fare_amount > 0) & (payment_type == 1) & (passenger_count < 7))

# removing outliers:
# per_tip laying outside IQR range in box plot
while (length(boxplot(processed_df$per_tip)$out) != 0){
  dim(processed_df)
  per_tip_outliers <- boxplot(processed_df$per_tip, col = c("#0000FF"))
  processed_df <- processed_df[ !processed_df$per_tip %in% per_tip_outliers$out,]
  dim(processed_df)
}
```

## Normality check
```{r}
processed_df %>%
  ggplot(aes(per_tip)) +
  geom_histogram(aes(y =..density..),
                   colour = "black", 
                   fill = "light blue") + stat_function(fun = dnorm, args = list(mean = mean(processed_df$per_tip), sd = sd(processed_df$per_tip)))
```


```{r}

processed_df$flag_tip <- ifelse(processed_df$per_tip > 0.00, "tipped", " No tip")

processed_df %>% ggplot(aes())+ +
  geom_bar(size=2, shape=23)
```
## EDA

```{r }

processed_df$passenger_count <- as.factor(processed_df$passenger_count)

processed_df %>%
  group_by(passenger_count) %>%
  count() %>%
  ggplot(aes(passenger_count, n, fill = passenger_count)) +
  geom_col() +
  scale_y_sqrt() +
  theme(legend.position = "none")

processed_df %>%
  ggplot(aes(VendorID, fill = VendorID)) +
  geom_bar() +
  theme(legend.position = "none")

```

EDA questions:
1. What places give max and min tip?
2. How is the tip amount varying?
3. What time of the day gives your more tip?
4. Distribution across count of passenger?
5. Distance and time variation in the trip?


```{r}
# Bar chart according to VendorID
processed_df %>% group_by(VendorID) %>% summarise(n = n(),average = mean(per_tip), min = min(per_tip),  max = max(per_tip))

ggplot(processed_df, aes(y=per_tip, group = VendorID)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)

hist(check_2$per_tip,probability=T, main="Histogram of normal
data",xlab="Approximately normally distributed data")
lines(density(check_2$per_tip),col=2)
```


```{r }
hist(processed_df$per_tip,probability=T, main="Histogram of normal
data",xlab="Approximately normally distributed data")
lines(density(processed_df$per_tip),col=2)


qqnorm(processed_df$per_tip)
qqline(processed_df$per_tip)

print(sd(processed_df$per_tip))

print(mean(processed_df$per_tip))
#per_tip_outliers
```




#### PUT DATA PROCESSING HERE####
## SAVE TO PROCESSED_DF######



#######



summary(processed_df)
```
```{r boxplot_pertip, include = T, echo = F}

boxplot(processed_df$tip_amount)
boxplot(processed_df$per_tip)
```

####################################


```{r}
# TANAYA

# anova tests 
anova_tip_amount = aov(per_tip ~ passenger_count, data = processed_df)
summary(anova_tip_amount)
```

####################################


```{r}
# MADHURI

```

####################################


```{r}
# AMNA

```

### GEOGRAPHIC LOCATION AND TIP
As previously discussed, location can also impact the amount of tipping. This is because each location has its own set of customs and traditions and socioeconomic variables that affect tipping [1]. In this context, a person's wealth may also impact the amount that he or she tips to the taxi driver. While most of this analysis was done on a larger, regional scale, given the distinct culture of each borough in New York, there may be microcosims of tipping culture found in the city that differ between each borough.
The dataset does not provide information on the passenger's home location, wealth, or even purpose of travel; it simply provides pick up and drop off locations. However, pick up and drop off locations may provide some context into a passenger's background for two main reasons. The first reason is quite simple: Passengers may use taxis to go from home to work and from work to home [2]. Secondly, each individual has their own time-space geography. Some geographers have argued that people's time-spaces are often segregated--whether due to gender or race--which can affect their access to resources. Therefore, this may provide some context into how an individual lives.


[1] https://scholarship.sha.cornell.edu/cgi/viewcontent.cgi?referer=&httpsredir=1&article=1102&context=articles
[2] https://ieeexplore.ieee.org/abstract/document/4624004; https://onlinelibrary.wiley.com/doi/pdf/10.1111/0033-0124.00158?casa_token=fgUlwmzlofwAAAAA:k19TGhhaKN9uLpNH1QXQgXrqRrm77fEgGmBisvuspaVDzvnNfXkrcvBvC4QsJMOmptyw8ew-qJWCd4s; https://biblio.ugent.be/publication/3029997/file/6779790.pdf; https://www.tandfonline.com/doi/full/10.1080/02723638.2016.1142152

To better understand this issue, descriptive statistics were run. First, we calculate the number of trips in each borough, firstly grouped by pickup location and secondly grouped by drop off location.

```{r location_barlot, include = T, echo = F}

barplot(summary(processed_df$Borough_pu))
barplot(summary(processed_df$Borough_do))
```

These bar charts show that Manhattan has the highest number of both pick up and drop offs, followed by Queens and Brooklyn in second and third, respectively. We also looked at the frequency of various drop off and pick up combinations.

```{r combo_pu_df, include = T, echo = F}
ddply(processed_df, .(Borough_pu, Borough_do), nrow)
```

This table shows that Manhattan to Manhattan has the highest number of trips, followed by Queens to Manhattan, Manhattan to Queens, and Manhattan to Brooklyn.

Considering the Manhattan and Queens have the highest number of pick ups and drop offs, the fact that the number of trips within and between these places are also the highest make sense. The fact that Manhattan scores the highest in both measurements is also reasonable because yellow taxis (the focus of this study) mainly serve Manhattan, whereas green taxis usually serve the other boroughs that have been traditionally underserved by taxis (SOURCE).

With these descriptive statistics in mind, we decided to compare the mean tipping amount for each borough based on drop off and pick up location to see if they were statistically different.

We used the ANOVA test. Here are the results for tip amount based on pick up location:

```{r anova_tip-amt_pu, include = T, echo = F}
# Run ANOVA
anova_location <- aov(tip_amount ~ Borough_pu, data = processed_df)

# Print ANOVA results
anova_location

# Summarize ANOVA
summary(anova_location)

# Plot rankings vs GRE
plot(tip_amount ~ Borough_pu, data = processed_df, main = "Title", xlab = "x", ylab = "y")

tukey_anova_location <- TukeyHSD(anova_location, conf.level = 0.95)

tukey_anova_location
```

Here are the results for tip amount based on drop off location:

```{r anova_tip-amt_do, include = T, echo = F}
# Run ANOVA
anova_location <- aov(tip_amount ~ Borough_do, data = processed_df)

# Print ANOVA results
anova_location

# Summarize ANOVA
summary(anova_location)

# Plot rankings vs GRE
plot(tip_amount ~ Borough_do, data = processed_df, main = "Title", xlab = "x", ylab = "y")

tukey_anova_location <- TukeyHSD(anova_location, conf.level = 0.95)

tukey_anova_location
```


We also compared the mean tipping percenetage for each borough to see if those were statistically different. Here are the results for tip percentage based on pick up location:

```{r anova_tip-percent_pu, include = T, echo = F}
# Run ANOVA
anova_location <- aov(per_tip ~ Borough_pu, data = processed_df)

# Print ANOVA results
anova_location

# Summarize ANOVA
summary(anova_location)

# Plot rankings vs GRE
plot(per_tip ~ Borough_pu, data = processed_df, main = "Title", xlab = "x", ylab = "y")

tukey_anova_location <- TukeyHSD(anova_location, conf.level = 0.95)

tukey_anova_location
```

Here are the results for tip percentage based on drop off location:

```{r anova_tip-percent_do, include = T, echo = F}
# Run ANOVA
anova_location <- aov(per_tip ~ Borough_do, data = processed_df)

# Print ANOVA results
anova_location

# Summarize ANOVA
summary(anova_location)

# Plot rankings vs GRE
plot(per_tip ~ Borough_do, data = processed_df, main = "Title", xlab = "x", ylab = "y")

tukey_anova_location <- TukeyHSD(anova_location, conf.level = 0.95)

tukey_anova_location
```

```{r TOBEDELETED}
# STEVEN
#ggplot(as.data.frame(tbl), aes(factor(Depth), Freq, fill = Species)) + geom_col(position = 'dodge')
plot(summary(processed_df$Borough_do))

#count(processed_df, c("Borough_pu", "Borough_do"))

ddply(processed_df, .(Borough_pu, Borough_do), nrow)


# ANOVA
# Box plot for tip vs locations

# Run ANOVA
anova_location <- aov(tip_amount ~ Borough_pu, data = processed_df)

# Print ANOVA results
anova_location

# Summarize ANOVA
summary(anova_location)

# Plot rankings vs GRE
plot(tip_amount ~ Borough_pu, data = processed_df, main = "Title", xlab = "x", ylab = "y")

tukey_anova_location <- TukeyHSD(anova_location, conf.level = 0.95)

tukey_anova_location

# Next task for STeven: # Subset by borough and run t test on each for tip amount, could also a box plot series for each borough grouped by payment type
# Or subset by payment type and do box plot series for each payment type grouped by borough
```
####################################